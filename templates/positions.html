{% extends "base.html" %}

{% block title %}Positions - Art University Job Scraper{% endblock %}

{% block content %}
<div id="alert-container"></div>

<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title">
                    <i class="fas fa-briefcase me-2"></i>Art & Media Art Positions
                </h1>
                <p class="card-text text-muted">
                    Discover opportunities in media art, digital art, AI art, and PhD programs at universities worldwide
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-section">
    <h5 class="mb-3">
        <i class="fas fa-filter me-2"></i>Filters
    </h5>
    <div class="row">
        <div class="col-md-3 mb-3">
            <label for="universityFilter" class="form-label">University</label>
            <select class="form-select" id="universityFilter">
                <option value="">All Universities</option>
            </select>
        </div>
        <div class="col-md-3 mb-3">
            <label for="positionTypeFilter" class="form-label">Position Type</label>
            <select class="form-select" id="positionTypeFilter">
                <option value="">All Types</option>
                <option value="media_art">Media Art</option>
                <option value="digital_art">Digital Art</option>
                <option value="ai_art">AI Art</option>
                <option value="artistic_research_phd">Artistic Research PhD</option>
                <option value="academic_positions">Academic Positions</option>
                <option value="phd">PhD Programs</option>
                <option value="jobs">Job Positions</option>
                <option value="specific_search">Specific Search</option>
            </select>
        </div>
        <div class="col-md-3 mb-3">
            <label for="languageFilter" class="form-label">Language</label>
            <select class="form-select" id="languageFilter">
                <option value="">All Languages</option>
                <option value="german">German</option>
                <option value="english">English</option>
                <option value="mixed">Mixed</option>
            </select>
        </div>
        <div class="col-md-3 mb-3">
            <label for="statusFilter" class="form-label">Status</label>
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="expired">Expired</option>
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="searchInput" class="form-label">Search</label>
            <input type="text" class="form-control search-box" id="searchInput" placeholder="Search positions...">
        </div>
        <div class="col-md-6 mb-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" onclick="applyFilters()">
                <i class="fas fa-search me-1"></i>Apply Filters
            </button>
            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                <i class="fas fa-times me-1"></i>Clear
            </button>
        </div>
    </div>
</div>

<!-- Results Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Search Results</h5>
                        <p class="text-muted mb-0" id="resultsCount">Loading...</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="exportResults()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                        <button class="btn btn-outline-success" onclick="refreshPositions()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Positions List -->
<div class="row">
    <div class="col-12">
        <div id="positionsContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading positions...</p>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Positions pagination">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Position Details Modal -->
<div class="modal fade" id="positionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="positionModalTitle">Position Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="positionModalBody">
                <!-- Position details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="positionModalLink" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i>View Original
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let positionsPerPage = 10;
let allPositions = [];
let filteredPositions = [];

$(document).ready(function() {
    loadUniversities();
    loadPositions();
    
    // Set up search input
    $('#searchInput').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            applyFilters();
        }
    });
    
    // Set up URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    if (searchParam) {
        $('#searchInput').val(searchParam);
        applyFilters();
    }
});

function loadUniversities() {
    $.get('/api/universities')
        .done(function(universities) {
            const select = $('#universityFilter');
            universities.forEach(function(uni) {
                select.append(`<option value="${uni.name}">${uni.name}</option>`);
            });
        });
}

function loadPositions() {
    $.get('/api/positions')
        .done(function(positions) {
            allPositions = positions;
            filteredPositions = [...positions];
            displayPositions();
            updateResultsCount();
        })
        .fail(function() {
            $('#positionsContainer').html(`
                <div class="alert alert-danger alert-custom">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading positions. Please try again.
                </div>
            `);
        });
}

function applyFilters() {
    const university = $('#universityFilter').val();
    const positionType = $('#positionTypeFilter').val();
    const language = $('#languageFilter').val();
    const status = $('#statusFilter').val();
    const searchTerm = $('#searchInput').val().toLowerCase();
    
    filteredPositions = allPositions.filter(function(position) {
        let matches = true;
        
        if (university && !position.university.toLowerCase().includes(university.toLowerCase())) {
            matches = false;
        }
        
        if (positionType && position.position_type !== positionType) {
            matches = false;
        }
        
        if (language && position.language !== language) {
            matches = false;
        }
        
        if (status && position.status !== status) {
            matches = false;
        }
        
        if (searchTerm) {
            const searchableText = `${position.title} ${position.description} ${position.university}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) {
                matches = false;
            }
        }
        
        return matches;
    });
    
    currentPage = 1;
    displayPositions();
    updateResultsCount();
}

function clearFilters() {
    $('#universityFilter').val('');
    $('#positionTypeFilter').val('');
    $('#languageFilter').val('');
    $('#statusFilter').val('');
    $('#searchInput').val('');
    
    filteredPositions = [...allPositions];
    currentPage = 1;
    displayPositions();
    updateResultsCount();
}

function displayPositions() {
    const startIndex = (currentPage - 1) * positionsPerPage;
    const endIndex = startIndex + positionsPerPage;
    const pagePositions = filteredPositions.slice(startIndex, endIndex);
    
    const container = $('#positionsContainer');
    
    if (pagePositions.length === 0) {
        container.html(`
            <div class="alert alert-info alert-custom">
                <i class="fas fa-info-circle me-2"></i>
                No positions found matching your criteria.
            </div>
        `);
        $('#pagination').empty();
        return;
    }
    
    let html = '';
    pagePositions.forEach(function(position) {
        const badgeClass = getBadgeClass(position.position_type);
        const languageFlag = getLanguageFlag(position.language);
        
        html += `
            <div class="position-card card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title mb-2">${position.title}</h5>
                            <p class="card-text text-muted mb-2">
                                <i class="fas fa-university me-1"></i>${position.university}
                            </p>
                            <p class="card-text">${truncateText(position.description, 200)}</p>
                            <div class="mt-2">
                                <span class="badge ${badgeClass} me-2">${position.position_type.replace('_', ' ').toUpperCase()}</span>
                                <span class="badge bg-secondary me-2">${languageFlag}</span>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>${formatDate(position.date_found)}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="mb-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="showPositionDetails(${position.id})">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                            </div>
                            <div>
                                <a href="${position.url}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>Visit Source
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
    generatePagination();
}

function getBadgeClass(positionType) {
    const classes = {
        'media_art': 'bg-primary',
        'digital_art': 'bg-success',
        'ai_art': 'bg-warning',
        'artistic_research_phd': 'bg-info',
        'academic_positions': 'bg-danger',
        'phd': 'bg-info',
        'jobs': 'bg-secondary',
        'specific_search': 'bg-dark'
    };
    return classes[positionType] || 'bg-secondary';
}

function getLanguageFlag(language) {
    const flags = {
        'german': '🇩🇪 DE',
        'english': '🇺🇸 EN',
        'mixed': '🌍 Mixed'
    };
    return flags[language] || '🌍 Unknown';
}

function showPositionDetails(positionId) {
    const position = allPositions.find(p => p.id === positionId);
    if (!position) return;
    
    $('#positionModalTitle').text(position.title);
    $('#positionModalLink').attr('href', position.url);
    
    const modalBody = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-university me-2"></i>University</h6>
                <p>${position.university}</p>
                
                <h6><i class="fas fa-tag me-2"></i>Position Type</h6>
                <p><span class="badge ${getBadgeClass(position.position_type)}">${position.position_type.replace('_', ' ').toUpperCase()}</span></p>
                
                <h6><i class="fas fa-language me-2"></i>Language</h6>
                <p>${getLanguageFlag(position.language)}</p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-calendar me-2"></i>Date Found</h6>
                <p>${formatDate(position.date_found)}</p>
                
                <h6><i class="fas fa-info-circle me-2"></i>Status</h6>
                <p><span class="badge ${position.status === 'active' ? 'bg-success' : 'bg-warning'}">${position.status.toUpperCase()}</span></p>
                
                <h6><i class="fas fa-link me-2"></i>Source URL</h6>
                <p><a href="${position.url}" target="_blank" class="text-break">${position.url}</a></p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6><i class="fas fa-align-left me-2"></i>Description</h6>
                <div class="border rounded p-3 bg-light">
                    ${position.description || 'No description available.'}
                </div>
            </div>
        </div>
    `;
    
    $('#positionModalBody').html(modalBody);
    $('#positionModal').modal('show');
}

function generatePagination() {
    const totalPages = Math.ceil(filteredPositions.length / positionsPerPage);
    const pagination = $('#pagination');
    
    if (totalPages <= 1) {
        pagination.empty();
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
    
    pagination.html(html);
}

function changePage(page) {
    if (page < 1 || page > Math.ceil(filteredPositions.length / positionsPerPage)) {
        return;
    }
    
    currentPage = page;
    displayPositions();
    
    // Scroll to top of results
    $('html, body').animate({
        scrollTop: $('#positionsContainer').offset().top - 100
    }, 500);
}

function updateResultsCount() {
    const count = filteredPositions.length;
    const total = allPositions.length;
    $('#resultsCount').text(`Showing ${count} of ${total} positions`);
}

function exportResults() {
    if (filteredPositions.length === 0) {
        showAlert('No positions to export', 'warning');
        return;
    }
    
    const csvContent = generateCSV(filteredPositions);
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `art_positions_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showAlert('Positions exported successfully!', 'success');
}

function generateCSV(positions) {
    const headers = ['University', 'Position Type', 'Title', 'Description', 'URL', 'Language', 'Date Found', 'Status'];
    const csvRows = [headers.join(',')];
    
    positions.forEach(function(position) {
        const row = [
            `"${position.university}"`,
            `"${position.position_type}"`,
            `"${position.title}"`,
            `"${position.description.replace(/"/g, '""')}"`,
            `"${position.url}"`,
            `"${position.language}"`,
            `"${position.date_found}"`,
            `"${position.status}"`
        ];
        csvRows.push(row.join(','));
    });
    
    return csvRows.join('\n');
}

function refreshPositions() {
    showAlert('Refreshing positions...', 'info');
    loadPositions();
}
</script>
{% endblock %}